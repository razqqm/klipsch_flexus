# Klipsch Flexus CORE 300 — full API control (legacy, pre-integration version)
# Klipsch Flexus CORE 300 — полное управление через нативный API (старая версия до интеграции)
# Author: ilia.ae | Date: 2026-02-15
#
# This is the original HA configuration before the custom integration was created.
# It uses command_line sensor + rest_command + scripts to control the soundbar.
# Kept here as reference for the API endpoints and data format.
#
# Replace <SOUNDBAR_IP> with your soundbar's IP address.

# Sensor: polls full state every 30s
# Сенсор: опрос полного состояния каждые 30 сек
command_line:
  - sensor:
      name: "Klipsch Volume"
      unique_id: klipsch_volume
      command: "python3 /config/scripts/klipsch_cast.py status"
      value_template: "{{ value_json.volume }}"
      unit_of_measurement: "%"
      json_attributes:
        - state
        - muted
        - input
        - mode
        - night_mode
        - dialog_mode
        - bass
        - mid
        - treble
        - power
        - decoder
        - eq_preset
        - dirac
        - sub_wired
        - sub_wireless
      scan_interval: 30
      icon: mdi:speaker

# REST commands — direct HTTP GET to Klipsch API (no restart needed)
# REST команды — прямые GET запросы к API (не требует рестарта)
rest_command:
  klipsch_volume_set:
    url: "http://<SOUNDBAR_IP>/api/setData?path=player:volume&roles=value&value=%7B%22type%22%3A%22i32_%22%2C%22i32_%22%3A{{ volume }}%7D"
    method: GET
  klipsch_mute:
    url: "http://<SOUNDBAR_IP>/api/setData?path=settings:/mediaPlayer/mute&roles=value&value=%7B%22type%22%3A%22bool_%22%2C%22bool_%22%3Atrue%7D"
    method: GET
  klipsch_unmute:
    url: "http://<SOUNDBAR_IP>/api/setData?path=settings:/mediaPlayer/mute&roles=value&value=%7B%22type%22%3A%22bool_%22%2C%22bool_%22%3Afalse%7D"
    method: GET
  klipsch_set_input:
    url: "http://<SOUNDBAR_IP>/api/setData?path=cinema:/external/physicalAudioInput&roles=value&value=%7B%22type%22%3A%22cinemaPhysicalAudioInput%22%2C%22cinemaPhysicalAudioInput%22%3A%22{{ source }}%22%7D"
    method: GET
  klipsch_set_mode:
    url: "http://<SOUNDBAR_IP>/api/setData?path=settings:/cinema/postProcessorMode&roles=value&value=%7B%22type%22%3A%22cinemaPostProcessorMode%22%2C%22cinemaPostProcessorMode%22%3A%22{{ mode }}%22%7D"
    method: GET
  klipsch_set_night:
    url: "http://<SOUNDBAR_IP>/api/setData?path=cinema:/nightMode&roles=value&value=%7B%22type%22%3A%22cinemaNightMode%22%2C%22cinemaNightMode%22%3A%22{{ mode }}%22%7D"
    method: GET
  klipsch_set_dialog:
    url: "http://<SOUNDBAR_IP>/api/setData?path=settings:/cinema/dialogMode&roles=value&value=%7B%22type%22%3A%22cinemaDialogMode%22%2C%22cinemaDialogMode%22%3A%22{{ mode }}%22%7D"
    method: GET
  klipsch_set_bass:
    url: "http://<SOUNDBAR_IP>/api/setData?path=cinema:cinemaBass&roles=value&value=%7B%22type%22%3A%22i32_%22%2C%22i32_%22%3A{{ value }}%7D"
    method: GET
  klipsch_set_mid:
    url: "http://<SOUNDBAR_IP>/api/setData?path=cinema:cinemaMid&roles=value&value=%7B%22type%22%3A%22i32_%22%2C%22i32_%22%3A{{ value }}%7D"
    method: GET
  klipsch_set_treble:
    url: "http://<SOUNDBAR_IP>/api/setData?path=cinema:cinemaTreble&roles=value&value=%7B%22type%22%3A%22i32_%22%2C%22i32_%22%3A{{ value }}%7D"
    method: GET
  klipsch_set_eq_preset:
    url: "http://<SOUNDBAR_IP>/api/setData?path=settings:/cinema/dsp/cinemaEqPreset&roles=value&value=%7B%22type%22%3A%22cinemaEqPreset%22%2C%22cinemaEqPreset%22%3A%22{{ preset }}%22%7D"
    method: GET
  klipsch_set_dirac:
    url: "http://<SOUNDBAR_IP>/api/setData?path=dirac:/activeFilter&roles=value&value=%7B%22type%22%3A%22i32_%22%2C%22i32_%22%3A{{ filter_id }}%7D"
    method: GET
  klipsch_set_sub_wired:
    url: "http://<SOUNDBAR_IP>/api/setData?path=settings:/cinema/dsp/wiredSubwooferVolume&roles=value&value=%7B%22type%22%3A%22i32_%22%2C%22i32_%22%3A{{ value }}%7D"
    method: GET
  klipsch_set_sub_wireless:
    url: "http://<SOUNDBAR_IP>/api/setData?path=settings:/cinema/dsp/wirelessSubwoofersVolume&roles=value&value=%7B%22type%22%3A%22i32_%22%2C%22i32_%22%3A{{ value }}%7D"
    method: GET
  klipsch_power:
    url: "http://<SOUNDBAR_IP>/api/setData?path=powermanager:targetRequest&roles=activate&value=%7B%22target%22%3A%22{{ target }}%22%2C%22reason%22%3A%22userActivity%22%7D"
    method: GET

# Scripts for dashboard buttons
# Скрипты для кнопок на дашборде
script:
  klipsch_set_volume:
    alias: "Klipsch: set volume"
    icon: mdi:volume-high
    fields:
      volume:
        description: "Volume level 0-100"
        example: "45"
    sequence:
      - action: rest_command.klipsch_volume_set
        data:
          volume: "{{ volume }}"

  klipsch_mute_toggle:
    alias: "Klipsch: mute toggle"
    icon: mdi:volume-off
    sequence:
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ state_attr('sensor.klipsch_volume', 'muted') }}"
            sequence:
              - action: rest_command.klipsch_unmute
        default:
          - action: rest_command.klipsch_mute

  klipsch_volume_up:
    alias: "Klipsch: volume +5"
    icon: mdi:volume-plus
    sequence:
      - action: rest_command.klipsch_volume_set
        data:
          volume: "{{ [states('sensor.klipsch_volume') | int + 5, 100] | min }}"

  klipsch_volume_down:
    alias: "Klipsch: volume -5"
    icon: mdi:volume-minus
    sequence:
      - action: rest_command.klipsch_volume_set
        data:
          volume: "{{ [states('sensor.klipsch_volume') | int - 5, 0] | max }}"

  klipsch_input:
    alias: "Klipsch: set input"
    icon: mdi:import
    fields:
      source:
        description: "Input: hdmiarc, bluetooth, hdmi1, spdif"
        example: "hdmiarc"
    sequence:
      - action: rest_command.klipsch_set_input
        data:
          source: "{{ source }}"

  klipsch_mode:
    alias: "Klipsch: set sound mode"
    icon: mdi:surround-sound
    fields:
      mode:
        description: "Sound mode: movie, music, night, game, sport, direct, surround, stereo"
        example: "movie"
    sequence:
      - action: rest_command.klipsch_set_mode
        data:
          mode: "{{ mode }}"

  klipsch_night:
    alias: "Klipsch: set night mode"
    icon: mdi:weather-night
    fields:
      mode:
        description: "Night mode: off, nightMode_1"
        example: "off"
    sequence:
      - action: rest_command.klipsch_set_night
        data:
          mode: "{{ mode }}"

  klipsch_night_toggle:
    alias: "Klipsch: night toggle"
    icon: mdi:weather-night
    sequence:
      - action: rest_command.klipsch_set_night
        data:
          mode: >
            {% if state_attr('sensor.klipsch_volume', 'night_mode') == 'off' %}nightMode_1{% else %}off{% endif %}

  klipsch_dialog:
    alias: "Klipsch: set dialog mode"
    icon: mdi:account-voice
    fields:
      mode:
        description: "Dialog mode: off, dialog_1, dialog_2, dialog_3"
        example: "off"
    sequence:
      - action: rest_command.klipsch_set_dialog
        data:
          mode: "{{ mode }}"

  klipsch_dialog_cycle:
    alias: "Klipsch: dialog cycle"
    icon: mdi:account-voice
    sequence:
      - action: rest_command.klipsch_set_dialog
        data:
          mode: >
            {% set d = state_attr('sensor.klipsch_volume', 'dialog_mode') %}
            {% if d == 'off' %}dialog_1{% elif d == 'dialog_1' %}dialog_2{% elif d == 'dialog_2' %}dialog_3{% else %}off{% endif %}

  klipsch_dirac_cycle:
    alias: "Klipsch: dirac cycle"
    icon: mdi:tune
    sequence:
      - action: rest_command.klipsch_set_dirac
        data:
          filter_id: >
            {% set d = state_attr('sensor.klipsch_volume', 'dirac') | int %}
            {% if d == -1 %}0{% elif d == 0 %}1{% elif d == 1 %}2{% else %}-1{% endif %}

  klipsch_eq:
    alias: "Klipsch: set EQ"
    icon: mdi:equalizer
    fields:
      param:
        description: "EQ parameter: bass, mid, treble"
        example: "bass"
      value:
        description: "EQ value (-6 to +6)"
        example: "0"
    sequence:
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ param == 'bass' }}"
            sequence:
              - action: rest_command.klipsch_set_bass
                data:
                  value: "{{ value }}"
          - conditions:
              - condition: template
                value_template: "{{ param == 'mid' }}"
            sequence:
              - action: rest_command.klipsch_set_mid
                data:
                  value: "{{ value }}"
          - conditions:
              - condition: template
                value_template: "{{ param == 'treble' }}"
            sequence:
              - action: rest_command.klipsch_set_treble
                data:
                  value: "{{ value }}"

  klipsch_eq_preset:
    alias: "Klipsch: set EQ preset"
    icon: mdi:tune-variant
    fields:
      preset:
        description: "EQ preset: flat, bass, rock, vocal"
        example: "flat"
    sequence:
      - action: rest_command.klipsch_set_eq_preset
        data:
          preset: "{{ preset }}"

  klipsch_dirac:
    alias: "Klipsch: set Dirac filter"
    icon: mdi:tune
    fields:
      filter_id:
        description: "Dirac filter: -1=off, 0/1/2=filter slots"
        example: "2"
    sequence:
      - action: rest_command.klipsch_set_dirac
        data:
          filter_id: "{{ filter_id }}"

  klipsch_sub:
    alias: "Klipsch: set subwoofer level"
    icon: mdi:subwoofer
    fields:
      which:
        description: "Subwoofer: sub_wired, sub_wireless"
        example: "sub_wired"
      value:
        description: "Level (-6 to +6)"
        example: "0"
    sequence:
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ which == 'sub_wired' }}"
            sequence:
              - action: rest_command.klipsch_set_sub_wired
                data:
                  value: "{{ value }}"
        default:
          - action: rest_command.klipsch_set_sub_wireless
            data:
              value: "{{ value }}"

  klipsch_power:
    alias: "Klipsch: power control"
    icon: mdi:power
    fields:
      target:
        description: "Power target: online, networkStandby"
        example: "online"
    sequence:
      - action: rest_command.klipsch_power
        data:
          target: "{{ target }}"
