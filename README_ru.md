# Klipsch Flexus CORE 300

**Language / Язык:** [English](README.md) | Русский

[![HACS Default](https://img.shields.io/badge/HACS-Default-41BDF5.svg?style=for-the-badge)](https://hacs.xyz/)
[![GitHub Release](https://img.shields.io/github/release/razqqm/klipsch_flexus.svg?style=for-the-badge)](https://github.com/razqqm/klipsch_flexus/releases)
[![License](https://img.shields.io/github/license/razqqm/klipsch_flexus.svg?style=for-the-badge)](LICENSE)

[![Validate](https://github.com/razqqm/klipsch_flexus/actions/workflows/validate.yaml/badge.svg)](https://github.com/razqqm/klipsch_flexus/actions/workflows/validate.yaml)
[![Hassfest](https://github.com/razqqm/klipsch_flexus/actions/workflows/hassfest.yaml/badge.svg)](https://github.com/razqqm/klipsch_flexus/actions/workflows/hassfest.yaml)
[![CI](https://github.com/razqqm/klipsch_flexus/actions/workflows/ci.yaml/badge.svg)](https://github.com/razqqm/klipsch_flexus/actions/workflows/ci.yaml)

Кастомная интеграция Home Assistant для **Klipsch Flexus CORE 300** — саундбар 5.1.2 с Dolby Atmos.

Управляет саундбаром через **локальный HTTP API** — без облака, без задержек. Частично заменяет приложение Klipsch Connect Plus для ежедневного использования.

> Саундбар должен быть предварительно настроен через официальное приложение Klipsch Connect Plus (Wi-Fi, прошивка, подключение колонок, калибровка Dirac). Интеграция отвечает только за управление.

## Возможности

### Медиаплеер
- **Громкость** — уровень, шаг вверх/вниз, выключение звука
- **Питание** — включение / режим ожидания
- **Источник сигнала** — TV ARC, HDMI, SPDIF, Bluetooth, Google Cast
- **Режим звука** — Movie, Music, Game, Sport, Night, Direct, Surround, Stereo
- **Воспроизведение** — play/pause, следующий/предыдущий трек
- **Медиа-данные** — название, артист, альбом, обложка, приложение-источник

### Уровни каналов (11 слайдеров, от -6 до +6 дБ)

| Канал | Описание |
|-------|----------|
| Front Height | Верхний фронтальный (Dolby Atmos) |
| Back Height | Верхний тыловой (Dolby Atmos) |
| Side Left / Right | Боковые окружающие колонки |
| Back Left / Right | Тыловые окружающие колонки |
| Subwoofer Wireless 1 / 2 | Беспроводные сабвуферы |
| Bass / Mid / Treble | Тембр: НЧ / СЧ / ВЧ |

### Настройки звука (Select)
- **EQ Preset** — Flat, Bass, Rock, Vocal
- **Ночной режим** — снижает динамический диапазон для тихого прослушивания
- **Режим диалога** — усиливает речь (3 уровня)
- **Dirac Live** — коррекция помещения (фильтры считываются с устройства)

### Диагностика
- **Время отклика** — длительность опроса API в мс, счётчики запросов/ошибок
- **Статус устройства** — Вкл / Ожидание / Оффлайн с информацией о декодере, входе, режиме
- **Скачать диагностику** — полный дамп состояния (Настройки > Устройства > Klipsch Flexus > Скачать диагностику)

### Переводы
Полный перевод интерфейса на **7 языков**: английский, русский, немецкий, испанский, французский, итальянский, португальский. Все имена сущностей, состояния и экраны настройки переведены.

## Установка

### HACS (рекомендуется)

1. Откройте **HACS** > Интеграции > найдите **Klipsch Flexus**
2. Установите и перезапустите Home Assistant
3. Перейдите в **Настройки** > Устройства и службы > **Добавить интеграцию** > Klipsch Flexus
4. Введите IP-адрес саундбара

### Вручную

1. Скопируйте `custom_components/klipsch_flexus/` в директорию `config/custom_components/` вашего HA
2. Перезапустите Home Assistant
3. Добавьте интеграцию через Настройки > Устройства и службы

## Конфигурация

| Параметр | По умолчанию | Описание |
|----------|-------------|----------|
| Host | — | IP-адрес саундбара (обязательно) |
| Интервал опроса | 15 с | Настраивается в опциях (5–120 с) |

**Совет:** Назначьте статический IP / DHCP-резервацию для стабильной работы.

Изменить IP можно позже через **Перенастройка** (Настройки > Устройства > Klipsch Flexus > Перенастройка).

## Как это работает

Саундбар предоставляет локальный HTTP API на порту 80:
- `GET /api/getData` — чтение параметров
- `GET /api/setData` — запись параметров
- `GET /api/getRows` — списки данных (фильтры Dirac)

### Устойчивая работа с медленным устройством

Klipsch Flexus имеет **однопоточный HTTP-сервер**, обрабатывающий один запрос за раз. Интеграция учитывает это ограничение:

| Механизм | Описание |
|----------|----------|
| Сериализация запросов | Все вызовы API проходят через `asyncio.Lock` — без параллелизма |
| Повторы с задержкой | Временные ошибки повторяются 2 раза с задержкой 0.5 с |
| Адаптивные таймауты | 8 с чтение, 10 с запись, 15 с команды питания |
| Грациозная деградация | При ошибке чтения используется последнее кешированное значение |
| Оптимистичные обновления | UI обновляется мгновенно, подтверждается отложенным опросом |

## Сущности

| Сущность | Тип | Категория |
|----------|-----|-----------|
| Klipsch Flexus CORE 300 | Медиаплеер | — |
| Ночной режим | Select | Конфигурация |
| Режим диалога | Select | Конфигурация |
| Эквалайзер | Select | Конфигурация |
| Фильтр Dirac | Select | Конфигурация |
| Back Height / Left / Right | Number (x3) | Конфигурация |
| Front Height | Number | Конфигурация |
| Side Left / Right | Number (x2) | Конфигурация |
| Subwoofer Wireless 1 / 2 | Number (x2) | Конфигурация |
| Bass / Mid / Treble | Number (x3) | Конфигурация |
| Время отклика | Sensor | Диагностика |
| Статус устройства | Sensor | Диагностика |

**Всего: 18 сущностей** (1 медиаплеер + 4 select + 11 number + 2 sensor)

## Решение проблем

| Проблема | Решение |
|----------|---------|
| Не подключается | Проверьте, что саундбар в той же сети. Попробуйте: `http://<IP>/api/getData?path=player:volume&roles=value` |
| Сущности недоступны | Приложение Klipsch может опрашивать одновременно — закройте его |
| Медленные обновления | Увеличьте интервал опроса в Настройках интеграции |
| Интеграция не загружается | Проверьте логи HA на ошибки импорта. Нужен HA 2024.4.0+ |

## Известные ограничения

- Один саундбар на запись интеграции (для нескольких — добавляйте отдельно)
- Нет управления мультирумом / группами беспроводных колонок (используйте Klipsch Connect Plus)
- AirPlay и Cast не используются — только нативный HTTP API
- Первоначальная настройка устройства требует приложения Klipsch Connect Plus

## Лицензия

MIT — см. [LICENSE](LICENSE).
